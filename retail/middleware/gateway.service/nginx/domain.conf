  
# vim: ft=nginx

server {
	listen 80;
	server_name ${ENV_RBX_NGINX_SERVER_NAME};
	root /app/public;
	client_max_body_size ${ENV_RBX_NGINX_MAX_BODY};

	location /api/v1/references/ {
		# try_files $uri =404;
		proxy_pass  http://${ENV_RBX_REFERENCE_HOST}:${ENV_RBX_REFERENCE_PORT};
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Host $server_name;
		proxy_set_header X-Forwarded-Proto https;
	}

	location /api/v1/onboarding/ {
		# try_files $uri =404;
		proxy_pass  http://${ENV_RBX_ONBOARDING_HOST}:${ENV_RBX_ONBOARDING_PORT};
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Host $server_name;
		proxy_set_header X-Forwarded-Proto https;
	}

	location /api/v1/entitlements/ {
		# try_files $uri =404;
		proxy_pass  http://${ENV_RBX_ENTITLEMENT_HOST}:${ENV_RBX_ENTITLEMENT_PORT};
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Host $server_name;
		proxy_set_header X-Forwarded-Proto https;
	}
	
	location / {
		# try_files $uri =404;
		proxy_pass  http://${ENV_RBX_PORTAL_HOST}:${ENV_RBX_PORTAL_PORT};
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Host $server_name;
		proxy_set_header X-Forwarded-Proto https;
	}
}
server {
    #listen 8080;
    #server_name onboarding.conduit-aiondigital.com 52.183.137.127 104.211.143.72 104.211.167.59;
    client_max_body_size 20M;

    location /api/v1 {
      proxy_set_header      Host $host;
      proxy_set_header      X-Real-IP $remote_addr;
      proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header      X-Forwarded-Proto $scheme;

      proxy_pass            http://gatewayservice:8080;
      proxy_read_timeout    90;
    }

    location /api/ {
      proxy_set_header      Host $host;
      proxy_set_header      X-Real-IP $remote_addr;
      proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header      X-Forwarded-Proto $scheme;
      #proxy_set_header     Forwarded $proxy_add_forwarded;

      proxy_pass            http://retail_gateway;
      proxy_read_timeout    90;
    }

   # rewrite ^(.*) https://$host$1 permanent;
}

################## Conduit API ##################

################## Mirrorfly Admin Panel ##################
server {
    listen 8083 ssl;
    server_name rubix-dev01.conduit-aiondigital.com;

    ssl_certificate           /etc/nginx/domainssl/domain.crt;
    ssl_certificate_key       /etc/nginx/domainssl/domain.key;

    ssl on;
    ssl_session_cache  builtin:1000  shared:SSL:10m;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!eNULL:!EXPORT:!CAMELLIA:!DES:!MD5:!PSK:!RC4;
    ssl_prefer_server_ciphers on;
    server_tokens off;
    location / {
        proxy_set_header      Host $host;
        proxy_set_header      X-Real-IP $remote_addr;
        proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header      X-Forwarded-Proto $scheme;
        proxy_set_header      Origin '';
        proxy_set_header X-Powered-By "";
        #more_clear_headers Server;
        #proxy_pass            http://onboarding_mw_webadmin:4200;
        proxy_read_timeout    90;
    }
}
######################Rubix Middleware Gateway#####################
server {
    listen 8444 ssl;
    server_name rubix-dev01.conduit-aiondigital.com;

    ssl_certificate           /etc/nginx/domainssl/domain.crt;
    ssl_certificate_key       /etc/nginx/domainssl/domain.key;

    ssl on;
    ssl_session_cache  builtin:1000  shared:SSL:10m;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!eNULL:!EXPORT:!CAMELLIA:!DES:!MD5:!PSK:!RC4;
    ssl_prefer_server_ciphers on;
    client_max_body_size 20M;
    server_tokens off;
    location / {
#        # switch off logging
        access_log off;

#        # redirect all HTTP traffic to HTTPS
        proxy_set_header Origin '';
        proxy_pass http://retail_gateway;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

#        # WebSocket support (nginx 1.4)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location /api {
      proxy_set_header      Host $host;
      proxy_set_header      X-Real-IP $remote_addr;
      proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header      X-Forwarded-Proto $scheme;

      proxy_pass            http://retail_gateway;
      proxy_read_timeout    90;
    }

   location /api/v1 {
      proxy_set_header      Host $host;
      proxy_set_header      X-Real-IP $remote_addr;
      proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header      X-Forwarded-Proto $scheme;

      proxy_pass            http://retail_gateway;
      proxy_read_timeout    90;
    }
}
###################################################################
################## Mirrorfly Admin Panel, API, Signal Service ##################
server {
    listen 8443 ssl;
    server_name rubix-dev01.conduit-aiondigital.com;

    ssl_certificate           /etc/nginx/domainssl/domain.crt;
    ssl_certificate_key       /etc/nginx/domainssl/domain.key;

    ssl on;
    ssl_session_cache  builtin:1000  shared:SSL:10m;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!eNULL:!EXPORT:!CAMELLIA:!DES:!MD5:!PSK:!RC4;
    ssl_prefer_server_ciphers on;
    client_max_body_size 20M;
    server_tokens off;
    location / {
        # switch off logging
        access_log off;

        # redirect all HTTP traffic to HTTPS
        proxy_set_header Origin '';
        proxy_pass http://video_portal:8080;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # WebSocket support (nginx 1.4)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location /api {
      proxy_set_header      Host $host;
      proxy_set_header      X-Real-IP $remote_addr;
      proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header      X-Forwarded-Proto $scheme;

      proxy_pass            http://gatewayservice:8080;
      proxy_read_timeout    90;
    }

    location /api/v1 {
      proxy_set_header      Host $host;
      proxy_set_header      X-Real-IP $remote_addr;
      proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header      X-Forwarded-Proto $scheme;

      proxy_pass           http://gatewayservice:8080;
      proxy_read_timeout   90;
    }

    location /signal/ {
    # switch off logging
        access_log off;

        # redirect all HTTP traffic to HTTPS
        proxy_set_header Origin '';
        proxy_pass http://signalservice:8080/;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # WebSocket support (nginx 1.4)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

    }
}
